name: Deploy to subpath - by folders name

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare output directory
        run: |
          rm -rf out
          mkdir out

      - name: Find all folders that contain index.html
        shell: bash
        run: |
          echo "Scanning folders..."
          for folder in */ ; do
            # Skip special folders
            if [[ "$folder" == ".github/" ]] || [[ "$folder" == "assets/" ]]; then
              continue
            fi

            if [[ -f "$folder/index.html" ]]; then
              folder_name=$(basename "$folder")
              echo "Deploying $folder_name"
              mkdir -p "out/$folder_name"
              rsync -av "$folder" "out/$folder_name/"
            else
              echo "Skipping $folder (no index.html)"
            fi
          done

      - name: Generate index.html
        run: |
          echo "<!DOCTYPE html><html><head><meta charset='utf-8'><title>Projects</title></head><body>" > out/index.html
          echo "<h1>Projects List</h1><ul>" >> out/index.html
          for d in out/*/; do
            name=$(basename "$d")
            echo "<li><a href='./$name/'>$name</a></li>" >> out/index.html
          done
          echo "</ul></body></html>" >> out/index.html

      - name: Deploy to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: out
